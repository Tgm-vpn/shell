#!/usr/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π WireGuard, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ PiVPN.
# –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—Ç –∏–º–µ–Ω–∏ root –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Debian 12.

# --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
BACKUP_DIR="/root/wireguard_backup" # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
TIMESTAMP=$(date +"%Y%m%d_%H%M%S") # –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
BACKUP_FILENAME="wireguard_configs_${TIMESTAMP}.tar.gz" # –ò–º—è —Ñ–∞–π–ª–∞ –∞—Ä—Ö–∏–≤–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏/—Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
WIREGUARD_CONFIG_DIR="/etc/wireguard"
PIVPN_INSTALL_SCRIPT_DIR="/opt/pivpn" # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PiVPN (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
log_info() {
    echo "INFO: $1"
}

log_error() {
    echo "ERROR: $1" >&2
}

log_success() {
    echo "SUCCESS: $1"
}

log_info "–ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard."

# --- 1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ ---
log_info "1/3: –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: $BACKUP_DIR"
mkdir -p "$BACKUP_DIR" || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ $BACKUP_DIR."; exit 1; }
log_success "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω–∞. ‚úÖ"

# --- 2. –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ ---
log_info "2/3: –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard: $BACKUP_FILENAME"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard
if [ ! -d "$WIREGUARD_CONFIG_DIR" ]; then
    log_error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard '$WIREGUARD_CONFIG_DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. WireGuard —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω?"
    exit 1
fi

# –ò—Å–ø–æ–ª—å–∑—É–µ–º tar –¥–ª—è —Å–∂–∞—Ç–∏—è –≤—Å–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /etc/wireguard.
# –≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç wg0.conf, /keys/ –∏ /configs/.
# –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º /opt/pivpn, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å PiVPN —Å–∫—Ä–∏–ø—Ç—ã/–¥–∞–Ω–Ω—ã–µ.
if [ -d "$PIVPN_INSTALL_SCRIPT_DIR" ]; then
    tar -czf "$BACKUP_DIR/$BACKUP_FILENAME" "$WIREGUARD_CONFIG_DIR" "$PIVPN_INSTALL_SCRIPT_DIR" || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏."; exit 1; }
else
    tar -czf "$BACKUP_DIR/$BACKUP_FILENAME" "$WIREGUARD_CONFIG_DIR" || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏."; exit 1; }
    log_info "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PiVPN '$PIVPN_INSTALL_SCRIPT_DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ."
fi

log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ $BACKUP_DIR/$BACKUP_FILENAME. üíæ"

# --- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ ---
log_info "3/3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
if [ -f "$BACKUP_DIR/$BACKUP_FILENAME" ]; then
    log_info "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: $(du -h "$BACKUP_DIR/$BACKUP_FILENAME" | awk '{print $1}')"
    log_success "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. ‚úÖ"
else
    log_error "–§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ '$BACKUP_FILENAME' –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å."
    exit 1
fi

log_info "–ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è WireGuard –∑–∞–≤–µ—Ä—à–µ–Ω."
log_info "–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PiVPN/WireGuard, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É–∂–±—É WireGuard, –∞ –∑–∞—Ç–µ–º –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —ç—Ç–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏."
log_info "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å PrivateKey —Å–µ—Ä–≤–µ—Ä–∞ –∏ IP-–∞–¥—Ä–µ—Å –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è."